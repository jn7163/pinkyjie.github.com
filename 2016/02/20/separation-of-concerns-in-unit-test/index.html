<!doctype html>
<html class="theme-next use-motion ">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


  <meta name="google-site-verification" content="o7yQBnLIoWby8Y5vNMQywBiMtev-ilWjXt89RQpTvVw" />



  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.2"/>


    <meta name="description" content="前端 | 溜冰 | Mac" />



  <meta name="keywords" content="AngularJS,ES6,angular1-webpack-starter,单元测试,关注分离,jasmine,karma-coverage,isparta," />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.2" />




  <title> 谈谈单元测试中的关注分离 // 进击的马斯特 </title>
</head>

<body>
  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">进击的马斯特</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>


  <ul id="menu" class="menu">
     
    <!--增加swiftype搜索功能-->
    <form class="menu-item menu-item-search">
      <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
    </form>
    
    <script type="text/javascript">
      (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
      (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
      e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
      })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

      _st('install','8k3UxSuRWYkrhVg55bC3','2.0.0');
    </script>
    <!--增加swiftype搜索功能end-->
    
    
      
      <li class="menu-item menu-item-home">
        <a href="/">
          <i class="menu-item-icon icon-home"></i> <br />
          首页
        </a>
      </li>
    
      
      <li class="menu-item menu-item-categories">
        <a href="/categories">
          <i class="menu-item-icon icon-categories"></i> <br />
          分类
        </a>
      </li>
    
      
      <li class="menu-item menu-item-tags">
        <a href="/tags">
          <i class="menu-item-icon icon-tags"></i> <br />
          标签
        </a>
      </li>
    
      
      <li class="menu-item menu-item-archives">
        <a href="/archives">
          <i class="menu-item-icon icon-archives"></i> <br />
          归档
        </a>
      </li>
    
      
      <li class="menu-item menu-item-about">
        <a href="/about">
          <i class="menu-item-icon icon-about"></i> <br />
          关于
        </a>
      </li>
    
  </ul>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              谈谈单元测试中的关注分离
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 2016-02-20
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; 分类于
            
              <a href="/categories/前端开发/">前端开发</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2016/02/20/separation-of-concerns-in-unit-test/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="_posts-2016-02-20-separation-of-concerns-in-unit-test"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        <p>前端的单元测试越来越受到重视，网上也有很多讲解Angular中如何写好单元测试的文章，我自己在最近的<a href="https://github.com/PinkyJie/angular1-webpack-starter" target="_blank" rel="external">angular1-webpack-starter</a>项目中也写了很多单元测试。单元测试的一个核心理念就是对“单元”进行隔离，然后单独测试。可是网上的很多教程存在不少误区：比如在controller的测试中去使用$httpBackend，在引入第三方service的时候使用真实的service等等，说到底都是没有实现“关注分离”（Separation of Concerns），“单元”没有真正的被隔离。这篇文章就谈谈Angular的单元测试中如何更好的实现关注分离。</p>
<a id="more"></a>
<h3 id="文件结构上的隔离"><a href="#文件结构上的隔离" class="headerlink" title="文件结构上的隔离"></a>文件结构上的隔离</h3><p>好的实践应该是Angular中一个单独的controller/service/provider/directive对应一个单独的spec文件，这是“大单元”的隔离，而每个单元又是由很多“小单元”（函数）组成的，而“小单元”同样需要隔离，那么每个函数可以对应一个spec文件里的describe块。看下面这个service的例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// user.service.js</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSerivce</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span> ($http, $q, $rootScope, Event, AjaxError) &#123;...&#125;</div><div class="line"></div><div class="line">    checkLoggedInStatus () &#123;...&#125;</div><div class="line"></div><div class="line">    login (email, password) &#123;...&#125;</div><div class="line"></div><div class="line">    logout () &#123;...&#125;</div><div class="line">&#125;</div><div class="line">UserSerivce.$inject = [<span class="string">'$http'</span>, <span class="string">'$q'</span>, <span class="string">'$rootScope'</span>, <span class="string">'Event'</span>, <span class="string">'AjaxErrorHandler'</span>];</div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> UserSerivce;</div><div class="line"></div><div class="line"><span class="comment">// user.service.spec.js</span></div><div class="line"><span class="keyword">import</span> UserService <span class="keyword">from</span> <span class="string">'./user.service'</span>;</div><div class="line"></div><div class="line">describe(<span class="string">'User Service'</span>, () =&gt; &#123;</div><div class="line"></div><div class="line">    beforeEach(...);</div><div class="line"></div><div class="line">    describe(<span class="string">'constructor function'</span>, () =&gt; &#123;...&#125;);</div><div class="line"></div><div class="line">    describe(<span class="string">'checkLoggedInStatus function'</span>, () =&gt; &#123;...&#125;);</div><div class="line"></div><div class="line">    describe(<span class="string">'login function'</span>, () =&gt; &#123;...&#125;);</div><div class="line"></div><div class="line">    describe(<span class="string">'logout function'</span>, () =&gt; &#123;...&#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>可以看到在测试的spec文件中，一个“大单元”对应顶层的describe，而“小单元”也有自己对应的子describe，这就从文件结构上保证了单元的隔离。当然这只是表面功夫，要做到更好的关注分离，我觉得要做到以下几点：</p>
<ul>
<li>让测试尽量脱离Angular框架本身。</li>
<li>能mock的依赖全mock，而且只mock需要直接依赖的部分。</li>
<li>对于外部依赖和内部依赖（比如controller的一个函数调用自己的另一个函数），直接spy。</li>
</ul>
<p>下面就以controller/service/provider的测试为例，来讲讲如何贯彻上面几点。需要说明的是，下面的代码都是基于jasmine和ES6的，但是一些思路和想法也同样适用于ES5。</p>
<h3 id="简单controller-service的测试可以脱离框架本身"><a href="#简单controller-service的测试可以脱离框架本身" class="headerlink" title="简单controller/service的测试可以脱离框架本身"></a>简单controller/service的测试可以脱离框架本身</h3><p>对于很多简单的controller和service，它不依赖Angular本身的特殊service（如<code>$rootScope</code>，<code>$http</code>等等），这个时候我们就可以甩开Angular测试里的<code>angular.mock.module</code>和<code>angular.mock.inject</code>这类框架特有的函数，直接在测试中mock它的构造函数的参数，然后new这个class进行测试即可。我们来看一个例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AjaxErrorHandlerService</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span> (Error, $q) &#123;</div><div class="line">        <span class="built_in">Object</span>.assign(<span class="keyword">this</span>, &#123;<span class="built_in">Error</span>, $q&#125;);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// directly reject with the human readable error message</span></div><div class="line">    catcher (reason) &#123;</div><div class="line">        <span class="keyword">const</span> type = <span class="keyword">typeof</span> reason;</div><div class="line">        <span class="keyword">let</span> code = <span class="string">'$UNEXPECTED'</span>;</div><div class="line">        <span class="keyword">if</span> (reason) &#123;</div><div class="line">            <span class="keyword">if</span> (type === <span class="string">'object'</span>) &#123;</div><div class="line">                code = reason.message;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'string'</span>) &#123;</div><div class="line">                code = reason;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.$q.reject(&#123;</div><div class="line">            code,</div><div class="line">            <span class="attr">text</span>: <span class="keyword">this</span>.Error.getErrorMessage(code)</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">AjaxErrorHandlerService.$inject = [<span class="string">'Error'</span>, <span class="string">'$q'</span>];</div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> AjaxErrorHandlerService;</div></pre></td></tr></table></figure>
<p>可以看到这个<code>AjaxErrorHandlerService</code>提供了一个统一的函数用来处理所有Ajax请求失败的情况，它有两个依赖：定义在其他文件中的名叫<code>Error</code>的service，以及Angular自身的<code>$q</code>。按照传统的Angular单元测试流程，我们需要这么写：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">describe(<span class="string">'AjaxErrorHandler Service'</span>, () =&gt; &#123;</div><div class="line">    <span class="keyword">let</span> ErrorService;</div><div class="line">    <span class="keyword">let</span> $q;</div><div class="line">    <span class="keyword">let</span> ajaxErrorHandler;</div><div class="line"></div><div class="line">    beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">        angular.mock.module(<span class="string">'theModuleContainsThisService'</span>);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">        angular.mock.inject(<span class="function">(<span class="params">_Error_, _$q_, _AjaxErrorHandler_</span>) =&gt;</span> &#123;</div><div class="line">            <span class="built_in">Error</span> = _Error_;</div><div class="line">            $q = _$q_;</div><div class="line">            ajaxErrorHandler = _AjaxErrorHandler_;</div><div class="line">            spyOn(<span class="built_in">Error</span>, <span class="string">'getErrorMessage'</span>);</div><div class="line">            spyOn($q, <span class="string">'reject'</span>);</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在上面的测试中，我们先使用angular-mock模块提供的module函数来加载service所在的module，然后使用inject来引入真实的<code>Error</code>和<code>$q</code>，spy其中的方法，最后再进行我们自己的测试。这里面的误区有两个：</p>
<ol>
<li>这个测试根本不需要使用Angular自身的module和inject</li>
<li>没必要引入真实的service依赖</li>
</ol>
<p>我们来看看修改后的测试(省略describe头)：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> AjaxErrorHandlerService <span class="keyword">from</span> <span class="string">'./ajax-error-handler.service'</span>;</div><div class="line"><span class="comment">// describe ...</span></div><div class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    ErrorService = jasmine.createSpyObj(<span class="string">'Error'</span>, [<span class="string">'getErrorMessage'</span>]);</div><div class="line">    $q = jasmine.createSpyObj(<span class="string">'$q'</span>, [<span class="string">'reject'</span>]);</div><div class="line">    ajaxErrorHandler = <span class="keyword">new</span> AjaxErrorHandlerService(ErrorService, $q);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>修改后的测试看起来简洁多了。首先，ES6中service的定义已经是class了，我们可以自行初始化它，没必要使用框架的inject。其次，它的所有依赖我们都可以直接使用mock的object，jasmine的<code>createSpyObj</code>可以创建一个mock的object，并且数组里指定的函数都自动被spy了，这也是我们为什么可以直接省略<code>spyOn()</code>调用的原因。可以看到，这个测试脱离了Angular框架本身，其次它没有真的引入真实的依赖，而是mock了它们，并且只mock自己需要的那部分函数（中括号里的部分）。这样，单元被彻底的隔离开了：</p>
<ul>
<li>即便以后这段代码用于非Angular框架了，测试依然有效。</li>
<li>就算其它的service的实现有问题，也不会影响这个测试。</li>
</ul>
<p>那有人要问了，我就是想要测A的时候发现A的依赖B有问题，好吧，那就从根本上违背了单元测试的初衷，不叫单元测试！关于<code>AjaxErrorHandlerService</code>的完整测试可以看<a href="https://github.com/PinkyJie/angular1-webpack-starter/blob/master/source/app/components/_common/services/ajax-error-handler.service.spec.js" target="_blank" rel="external">这里</a>。</p>
<p>还有一个例子也很常见，那就是我们常常需要测试<code>$rootScope.$on(xxx, xxx)</code>，也就是需要测试Angular里的事件响应。看下面这个例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    $rootScope.$on(<span class="string">'$stateChangeSuccess'</span>, (event, toState) =&gt; &#123; ... &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当我们要测试这个<code>foo</code>函数的时候，我们很自然的想到可以调用<code>$rootScope.$broadcast(&#39;$stateChangeSuccess&#39;);</code>，这样就可以fire一个事件，foo函数里定义的事件回调就可以触发了。这样一来，又出现了需要依赖Angular框架的情况。其实，这种情况下我们依然可以杜绝这种依赖。回到测试本身，其实我们需要测试的是后面的回调函数，因为<code>$on</code>这个机制是由框架本身保证的，我们不应该去测这个机制，我们只要保证回调里的逻辑就好了。那么我们可以这么测：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">it (<span class="string">'should work'</span>, () =&gt; &#123;</div><div class="line">    foo();</div><div class="line">    <span class="comment">// 假设前面已经mock一个假的$rootScope</span></div><div class="line">    expect($rootScope.$on).toHaveBeenCalled();</div><div class="line">    expect($rootScope.$on.calls.argsFor(<span class="number">0</span>)[<span class="number">0</span>]).toBe(<span class="string">'$stateChangeSuccess'</span>);</div><div class="line">    <span class="keyword">const</span> callback = $rootScope.$on.calls.argsFor(<span class="number">0</span>)[<span class="number">1</span>];</div><div class="line">    callback(&#123;...&#125;, &#123;...&#125;);</div><div class="line">    <span class="comment">// expect logic in callback</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>上面的测试并没有引入真正的<code>$rootScope</code>，它只验证<code>$on</code>被调用过（第4行），并且第一个参数是<code>$stateChangeSuccess</code>（第5行），然后通过jasmine的<code>argsFor(0)[1]</code>拿到callback（第6行），意思就是第1次调用时的第2个参数，显然，第2个参数就是我们要测的回调函数本身。拿到了回调函数，我们只要给定参数执行它，然后在expect里面的一些逻辑即可。在这个例子里，我们再次做到了关注分离，我们的关注点只放在了自己实现的回调上，而框架本身的事件机制我们选择忽略。</p>
<p>当然，有些情况下我们无法脱离Angular框架，必须要引入真实的service，我总结了一下大概有以下几种情况：</p>
<ul>
<li>测试directive时需要<code>$compile</code>和<code>$rootScope</code>：<ul>
<li>用<code>$compile</code>来编译含有directive的HTML代码。</li>
<li>用<code>$rootScope.$new()</code>来生成directive的scope（用于link函数里）。</li>
</ul>
</li>
<li>测含有HTTP请求的service时需要使用<code>$httpBackend</code>：使用<code>$httpBackend.expectXXX(xxx)</code>来模拟HTTP请求的返回。</li>
<li>测promise的时候需要<code>$q</code>和<code>$rootScope</code>：（下一节会详细讲到）<ul>
<li>使用<code>const deferred = $q.defer()</code>来生成一个deferred的对象，然后在需要promise的地方使用<code>deferred.promise</code>代替。</li>
<li>使用<code>$rootScope.$digest()</code>来使promise的结果生效。</li>
</ul>
</li>
</ul>
<h3 id="controller的测试里不要出现-httpBackend，测service时才需要它"><a href="#controller的测试里不要出现-httpBackend，测service时才需要它" class="headerlink" title="controller的测试里不要出现$httpBackend，测service时才需要它"></a>controller的测试里不要出现$httpBackend，测service时才需要它</h3><p>这是我一开头就提到的问题，我们来看下面这个controller和service：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// user.service.js</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSerivce</span> </span>&#123;</div><div class="line">    login (email, password) &#123;</div><div class="line">        <span class="keyword">const</span> self = <span class="keyword">this</span>;</div><div class="line">        <span class="keyword">const</span> req = &#123;</div><div class="line">            email,</div><div class="line">            password</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.$http.post(<span class="string">'api/user/login'</span>, req)</div><div class="line">            .then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</div><div class="line">                <span class="keyword">const</span> data = response.data;</div><div class="line">                <span class="keyword">if</span> (response.status === <span class="number">200</span> &amp;&amp; data.code === <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">return</span> data.result.user;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> self.$q.reject(data.message);</div><div class="line">            &#125;)</div><div class="line">            .catch(<span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</div><div class="line">                <span class="keyword">return</span> self.$q.reject(reason);</div><div class="line">            &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// login.controller.js</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginController</span> </span>&#123;</div><div class="line">    login (credential) &#123;</div><div class="line">        <span class="keyword">this</span>.User.login(credential.email, credential.password)</div><div class="line">            .then(...)</div><div class="line">            .catch(...);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在测试这个controller时，很多文章直接这样写：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$httpBackend.expectPOST(<span class="string">'api/user/login'</span>).respond(&#123;<span class="attr">code</span>: <span class="number">0</span>, <span class="attr">result</span>: &#123;<span class="attr">user</span>: <span class="string">'user'</span>&#125;&#125;);</div><div class="line">controller.login(...);</div><div class="line">$httpBackend.flush();</div><div class="line">expect(...) <span class="comment">// check logic in controller then branch</span></div></pre></td></tr></table></figure>
<p>然后到了测试service时，还是这么写：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$httpBackend.expectPOST(<span class="string">'api/user/login'</span>).respond(&#123;<span class="attr">code</span>: <span class="number">0</span>, <span class="attr">result</span>: &#123;<span class="attr">user</span>: <span class="string">'user'</span>&#125;&#125;);</div><div class="line">UserService.login(...);</div><div class="line">$httpBackend.flush();</div><div class="line">expect(...) <span class="comment">// check logic in service then branch</span></div></pre></td></tr></table></figure>
<p>请问有什么区别吗？service这么写无可厚非，因为它依赖<code>$http</code>，所以测试的时候拿<code>$httpBackend</code>去mock是合理的，可是controller的直接依赖是service而不是<code>$http</code>，为什么也要这么mock呢？这就有点越俎代庖的意思，你不mock你的直接依赖，而是去mock你的依赖的依赖。显然，这不是一种好的隔离。</p>
<p>那么回到controller来说，它的直接依赖是<code>User.login</code>这个函数，那么我们只需要去mock这个函数就好，那么这个函数返回的是什么呢？没错，是一个promise。那么测controller的时候我们只需要去mock这个promise就好了，看下面的代码（变量定义已省略，完整的代码见<a href="https://github.com/PinkyJie/angular1-webpack-starter/blob/master/source/app/components/login-form/login-form.controller.spec.js" target="_blank" rel="external">这里</a>）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    angular.mock.inject(<span class="function">(<span class="params">_$q_, _$rootScope_</span>) =&gt;</span> &#123;</div><div class="line">        $q = _$q_;</div><div class="line">        $rootScope = _$rootScope_;</div><div class="line">        UserAPI = jasmine.createSpyObj(<span class="string">'UserAPI'</span>, [<span class="string">'login'</span>]);</div><div class="line">        controller = <span class="keyword">new</span> LoginController(UserAPI);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">describe(<span class="string">'login function'</span>, () =&gt; &#123;</div><div class="line">    beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">        deferred = $q.defer();</div><div class="line">        UserAPI.login.and.returnValue(deferred.promise);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    it(<span class="string">'should success'</span>, () =&gt; &#123;</div><div class="line">        deferred.resolve(...);</div><div class="line">        controller.login(...);</div><div class="line">        $rootScope.$digest();</div><div class="line">        expect(...) <span class="comment">// check logic in then branch</span></div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>上面的测试中引入了真实的<code>$q</code>和<code>$rootScope</code>，这就是我们上一小节提到的测试promise时需要的。第12、13行我们使用<code>$q</code>构造一个promise对象，让mock后的login函数返回这个promise，然后在后面的测试中，我们直接控制这个promise是resolve还是reject即可（第17行）。注意，第19行的<code>$rootScope.$digest()</code>是框架本身的要求，我们需要这行代码让promise的结果生效。这样一来，controller的测试就与它背后的HTTP请求隔离开了，因为它只关心promise的resolve或reject，只有service才需要去关注HTTP的返回。</p>
<p>这里顺带一提，测试service的时候需要让<code>$httpBackend</code>模拟返回3个结果：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">apiResponse.respond(&#123;<span class="attr">code</span>: <span class="number">0</span>, <span class="attr">result</span>: &#123;<span class="attr">user</span>: <span class="string">'user'</span>&#125;&#125;);</div><div class="line">apiResponse.respond(&#123;<span class="attr">code</span>: <span class="number">1</span>, <span class="attr">message</span>: <span class="string">'error'</span>&#125;);</div><div class="line">apiResponse.respond(<span class="function"><span class="params">()</span> =&gt;</span> &#123;<span class="keyword">return</span> [<span class="number">500</span>];&#125;);</div></pre></td></tr></table></figure>
<p>这是基于测试覆盖率的考量，因为可以看到service的实现逻辑中，2xx的返回会进入then分支，非2xx的返回进入catch分支，而在then分支中手动执行<code>$q.reject()</code>也会进入catch分支。而测试controller时，因为它关心的只是promise，所以只需要模拟resolve和reject两种结果即可。</p>
<h3 id="让module-inject引入我们mock过的provider-service"><a href="#让module-inject引入我们mock过的provider-service" class="headerlink" title="让module/inject引入我们mock过的provider/service"></a>让module/inject引入我们mock过的provider/service</h3><p>有些情况下，我们必须使用inject来引入一些provider和service，比如在测试provider的时候，因为provider的初始化并不像controller或service那样可以直接new，它是由框架本身来初始化的，并且<code>.provider(&#39;RouterHelper&#39;, RouterHelperProvider)</code>的定义会同时得到一个<code>RouterHelperProvider</code>的provider和一个<code>RouterHelper</code>的service。所以在测provider的时候我们只能通过module来实现，但即便这样我们依然可以让module/inject加载我们已经mock过的provider和service。我们来看下面这个provider的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouterHelperProvider</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span> ($locationProvider, $stateProvider, $urlRouterProvider) &#123;</div><div class="line">        <span class="built_in">Object</span>.assign(<span class="keyword">this</span>, &#123;$locationProvider, $stateProvider, $urlRouterProvider&#125;);</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.config = &#123;</div><div class="line">            <span class="attr">mainTitle</span>: <span class="string">''</span>,</div><div class="line">            <span class="attr">resolveAlways</span>: &#123;&#125;</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">this</span>.$locationProvider.html5Mode(<span class="literal">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    configure (cfg) &#123;</div><div class="line">        angular.extend(<span class="keyword">this</span>.config, cfg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $get ($rootScope, $state, Logger, Resolve) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RouterHelper(</div><div class="line">            <span class="keyword">this</span>.config, <span class="keyword">this</span>.$stateProvider, <span class="keyword">this</span>.$urlRouterProvider,</div><div class="line">            $rootScope, $state, Logger, Resolve);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">RouterHelperProvider.prototype.$get.$inject = [</div><div class="line">    <span class="string">'$rootScope'</span>, <span class="string">'$state'</span>, <span class="string">'Logger'</span>, <span class="string">'Resolve'</span></div><div class="line">];</div><div class="line"></div><div class="line">RouterHelperProvider.$inject = [<span class="string">'$locationProvider'</span>, <span class="string">'$stateProvider'</span>, <span class="string">'$urlRouterProvider'</span>];</div></pre></td></tr></table></figure>
<p>对于RouterHelperProvider和RouterHelper的依赖我们都需要来mock，要实现这一点其实我们只要<strong>在运行<code>angular.mock.module(&#39;xxx&#39;)</code>之前进行provider的mock</strong>即可：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> RouterHelperProvider <span class="keyword">from</span> <span class="string">'./router-helper.provider'</span>;</div><div class="line"></div><div class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    angular.module(<span class="string">'test'</span>, [])</div><div class="line">        .provider(<span class="string">'RouterHelper'</span>, RouterHelperProvider);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    <span class="comment">// function passed to module() does not get called until inject() does it's thing</span></div><div class="line">    angular.mock.module(<span class="function">(<span class="params">$provide</span>) =&gt;</span> &#123;</div><div class="line">        <span class="comment">// provider needs to be mocked before module load</span></div><div class="line">        $provide.provider(<span class="string">'$location'</span>, jasmine.createSpyObj(<span class="string">'$locationProvider'</span>, [<span class="string">'html5Mode'</span>, <span class="string">'$get'</span>]));</div><div class="line">        $provide.provider(<span class="string">'$urlRouter'</span>, jasmine.createSpyObj(<span class="string">'$urlRouterProvider'</span>, [<span class="string">'otherwise'</span>, <span class="string">'$get'</span>]));</div><div class="line">        $provide.provider(<span class="string">'$state'</span>, jasmine.createSpyObj(<span class="string">'$stateProvider'</span>, [<span class="string">'state'</span>, <span class="string">'$get'</span>]));</div><div class="line">        $provide.value(<span class="string">'$rootScope'</span>, jasmine.createSpyObj(<span class="string">'$rootScope'</span>, [<span class="string">'$on'</span>]));</div><div class="line">        $provide.value(<span class="string">'Logger'</span>, jasmine.createSpyObj(<span class="string">'Logger'</span>, [<span class="string">'warning'</span>]));</div><div class="line">        $provide.value(<span class="string">'Resolve'</span>, jasmine.createSpyObj(<span class="string">'Resolve'</span>, [<span class="string">'login'</span>]));</div><div class="line">    &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    angular.mock.module(<span class="string">'test'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    angular.mock.module((_$locationProvider_, _$stateProvider_,</div><div class="line">        _$urlRouterProvider_, _RouterHelperProvider_) =&gt; &#123;</div><div class="line">        $locationProvider = _$locationProvider_;</div><div class="line">        $stateProvider = _$stateProvider_;</div><div class="line">        $stateProvider.$get.and.returnValue(jasmine.createSpyObj(<span class="string">'$get'</span>, [<span class="string">'get'</span>, <span class="string">'go'</span>]));</div><div class="line">        $urlRouterProvider = _$urlRouterProvider_;</div><div class="line">        provider = _RouterHelperProvider_;</div><div class="line">    &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    angular.mock.inject(<span class="function">(<span class="params">_$rootScope_, _$state_, _Logger_, _Resolve_</span>) =&gt;</span> &#123;</div><div class="line">        $rootScope = _$rootScope_;</div><div class="line">        $state = _$state_;</div><div class="line">        Logger = _Logger_;</div><div class="line">        Resolve = _Resolve_;</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>上面的测试包含5块beforeEach，每一块都有自己的分工：</p>
<ol>
<li>定义我们自己的provider，我们把它定义在自己的<code>test</code>module上而不是真实的module上，这样可以更好的隔离。</li>
<li>mock需要的各种provider，我们知道provider是带有<code>$get</code>函数的特殊的class，所以我们只需要保证mock后的provider包含<code>$get</code>及我们要用的其他函数即可。</li>
<li>加载这个<code>test</code>的module。</li>
<li>引入我们mock过的provider依赖，注意第30行有些特殊。我们的目标是mock<code>$state</code>这个service里的<code>get</code>和<code>go</code>函数，但这个<code>$state</code>service是我们mock的<code>$stateProvider</code>这个provider的<code>$get</code>函数生成的，所以我们需要直接mock这个<code>$get</code>的返回值，让其继续返回一个可以spy的object。如果我们不这样做，而是直接在inject函数里尝试<code>spyOn($state, &#39;get&#39;)</code>的话就会报错，因为这里的<code>$state</code>是没有<code>get</code>这个函数的。</li>
<li>引入我们mock过的service依赖。</li>
</ol>
<p>这样，所有的依赖虽然都是通过module/inject引入进来的，但是它依然是我们mock过的。这里的顺序值得注意，对于provider的mock必须在调用<code>angular.mock.module(&#39;test&#39;);</code>（第3个beforeEach块）之前，否则得到的就不是你mock过的provider，而是框架自带的provider。如果是第3方的provider如<code>$stateProvider</code>，如果放在module加载之后再mock，加载module时就会报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Error: [$injector:modulerr] Failed to instantiate module test due to:</div><div class="line">Error: [$injector:unpr] Unknown provider: $stateProvider</div></pre></td></tr></table></figure>
<p>这是因为其实<code>$stateProvider</code>根本就不在<code>test</code>这个module里，我们必须在加载module之前mock它，所以必须保证自定义provider的其它provider依赖都mock好了才能初始化这个module。但是service的mock就不需要这么做，我们把第15-17行移动到第3个beforeEach后面也是可行的。</p>
<h3 id="其它小tip"><a href="#其它小tip" class="headerlink" title="其它小tip"></a>其它小tip</h3><p>最后讲一些单元测试里其它的小tip。</p>
<h4 id="整合jquey插件的directive的测试流程"><a href="#整合jquey插件的directive的测试流程" class="headerlink" title="整合jquey插件的directive的测试流程"></a>整合jquey插件的directive的测试流程</h4><p>我们先来看一个简单的directive，它的link函数里只做一件事，调用jquery插件的dropdown函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">DropdownInitDirective</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">restrict</span>: <span class="string">'A'</span>,</div><div class="line">        link</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">link</span> (<span class="params">scope, element</span>) </span>&#123;</div><div class="line">        element.dropdown();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">DropdownInitDirective.$inject = [];</div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> DropdownInitDirective;</div></pre></td></tr></table></figure>
<p>再来看看如何测试它：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> DropdownInitDirective <span class="keyword">from</span> <span class="string">'./dropdown-init.directive'</span>;</div><div class="line"></div><div class="line">describe(<span class="string">'DropdownInit Directive'</span>, () =&gt; &#123;</div><div class="line">    <span class="keyword">let</span> scope;</div><div class="line"></div><div class="line">    beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">        angular.module(<span class="string">'test'</span>, [])</div><div class="line">            .directive(<span class="string">'aioDropdownInit'</span>, DropdownInitDirective);</div><div class="line">        angular.mock.module(<span class="string">'test'</span>);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">        angular.mock.inject(<span class="function">(<span class="params">$rootScope, $compile</span>) =&gt;</span> &#123;</div><div class="line">            scope = $rootScope.$<span class="keyword">new</span>();</div><div class="line">            spyOn($.fn, <span class="string">'dropdown'</span>).and.callThrough();</div><div class="line">            $compile(<span class="string">'&lt;a aio-dropdown-init&gt;&lt;/a&gt;'</span>)(scope);</div><div class="line">            scope.$digest();</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    it(<span class="string">'should call dropdown function when initialization'</span>, () =&gt; &#123;</div><div class="line">        expect($.fn.dropdown).toHaveBeenCalled();</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>directive的一般测试流程是：</p>
<ol>
<li>使用$rootScope来生成新的scope作为directive的scope（第14行）</li>
<li>使用$compile来编译HTML代码并绑定scope（第16行）</li>
<li>执行<code>scope.$diget()</code>使绑定的scope生效</li>
</ol>
<p>这里有一点特殊的地方就是第15行，实现代码里是调用的<code>element.dropdown</code>，但我们spy的却是jquery的<code>$.fn.dropdown</code>，这是因为element元素是$compile后才能返回的（第16行），而一旦返回，它的link函数就已经被立即调用了。所以，在第16行后去执行<code>spyOn(element, &#39;dropdown&#39;)</code>已经来不及，而在第16行之前执行呢，这时element还没有dropdown这个函数。所以对<code>$.fn</code>进行spy是一个折衷的方法，因为所有的jquey插件最终都是定义在<code>$.fn</code>上的。但是这么一来有些违反单元测试的原则，目前我也没想到更好的方案。</p>
<h4 id="将重复的测试代码重构成函数"><a href="#将重复的测试代码重构成函数" class="headerlink" title="将重复的测试代码重构成函数"></a>将重复的测试代码重构成函数</h4><p>这一点不用所说，将重用的代码提取出来是编程中最常见的重构。单元测试中也存在很多这样的重复代码，一个最常见的例子就是在测试service的时候，2xx和非2xx的返回都有可能进入reject分支，所以在验证reject分支逻辑的时候就需要写两次，这时就可以把这些重复的代码提出来变成函数。看下面这个例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">describe(<span class="string">'login function'</span>, () =&gt; &#123;</div><div class="line">    <span class="keyword">let</span> apiResponse;</div><div class="line">    beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">        spyOn(User, <span class="string">'_setUser'</span>);</div><div class="line">        spyOn(User, <span class="string">'_clearUser'</span>);</div><div class="line">        apiResponse = $httpBackend.expectPOST(<span class="string">'api/user/login'</span>);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">assertError</span> (<span class="params">error</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">            expect(User._setUser).not.toHaveBeenCalled();</div><div class="line">            expect($rootScope.$broadcast).not.toHaveBeenCalled();</div><div class="line">            expect($q.reject).toHaveBeenCalledWith(error);</div><div class="line">            expect(User._clearUser).toHaveBeenCalled();</div><div class="line">            expect(AjaxErrorHandler.catcher).toHaveBeenCalledWith(error);</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    it(<span class="string">'should not login user when API returns error result'</span>, () =&gt; &#123;</div><div class="line">        apiResponse.respond(&#123;<span class="attr">code</span>: <span class="number">1</span>, <span class="attr">message</span>: <span class="string">'error'</span>&#125;);</div><div class="line">        User.login(<span class="string">'a'</span>, <span class="string">'b'</span>).catch(assertError(<span class="string">'error'</span>));</div><div class="line">        $httpBackend.flush();</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    it(<span class="string">'should not login user when API returns 500'</span>, () =&gt; &#123;</div><div class="line">        apiResponse.respond(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">            <span class="keyword">return</span> [<span class="number">500</span>];</div><div class="line">        &#125;);</div><div class="line">        User.login(<span class="string">'a'</span>, <span class="string">'b'</span>).catch(assertError(<span class="literal">null</span>));</div><div class="line">        $httpBackend.flush();</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="测试覆盖率"><a href="#测试覆盖率" class="headerlink" title="测试覆盖率"></a>测试覆盖率</h4><p>一旦开始写测试就一定要加入测试覆盖率的统计，它不光是一个“看自己到底写了百分之多少的测试”的提醒，更重要的是它绝壁是写测试的最大动力。想想游戏里的成就系统，有时为了拿100%物品搜集成就即便通关了也要重来一遍。单元测试里的覆盖率统计也有同样的作用，有的时候不为别的，就想看那个数字跑到100%。ES5中我们有<a href="https://github.com/karma-runner/karma-coverage" target="_blank" rel="external">karma-coverage</a>配合<a href="https://github.com/gotwarlost/istanbul" target="_blank" rel="external">istanbul</a>，ES6中karma-coverage依然有效，但是我们需要<a href="https://github.com/douglasduteil/isparta" target="_blank" rel="external">isparta</a>——一个针对ES6的代码覆盖工具。你需要做的就是把它配置到karma的配置文件中，具体可以参考angular1-webpack-starter项目的<a href="https://github.com/PinkyJie/angular1-webpack-starter/blob/master/karma.config.js" target="_blank" rel="external">karma.conf.js</a>。</p>

      
    </div>

    <div class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/AngularJS/"> #AngularJS </a>
          
            <a href="/tags/ES6/"> #ES6 </a>
          
            <a href="/tags/angular1-webpack-starter/"> #angular1-webpack-starter </a>
          
            <a href="/tags/单元测试/"> #单元测试 </a>
          
            <a href="/tags/关注分离/"> #关注分离 </a>
          
            <a href="/tags/jasmine/"> #jasmine </a>
          
            <a href="/tags/karma-coverage/"> #karma-coverage </a>
          
            <a href="/tags/isparta/"> #isparta </a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/02/21/e2e-testing-in-angular/">Angular里的E2E测试</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/02/11/angular-1-x-with-es6/">ES6与Angular 1.x</a>
            
          </div>
        </div>
      

      
      
    </div>
  </div>



    
      <div class="comments" id="comments">
        
          <div class="ds-thread" data-thread-key="_posts-2016-02-20-separation-of-concerns-in-unit-test"
               data-title="谈谈单元测试中的关注分离" data-url="http://pinkyjie.com/2016/02/20/separation-of-concerns-in-unit-test/">
          </div>
        
      </div>
    
  </div>


        </div>
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview">
        <div class="site-author motion-element">
          <img class="site-author-image" src="http://pinkyjie-blog.qiniudn.com/images/avatar.jpg" alt="马斯特" />
          <p class="site-author-name">马斯特</p>
        </div>
        <p class="site-description motion-element">前端 | 溜冰 | Mac</p>
        <div class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">53</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">8</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">184</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </div>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
              <a href="https://github.com/PinkyJie" target="_blank">GitHub</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="https://twitter.com/PinkyJie" target="_blank">Twitter</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://weibo.com/pinkyway" target="_blank">Weibo</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://stackoverflow.com/users/689948/pinkyjie" target="_blank">StackOverflow</a>
            </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

      </div>

      
        <div class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#文件结构上的隔离"><span class="nav-number">1.</span> <span class="nav-text">文件结构上的隔离</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#简单controller-service的测试可以脱离框架本身"><span class="nav-number">2.</span> <span class="nav-text">简单controller/service的测试可以脱离框架本身</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#controller的测试里不要出现-httpBackend，测service时才需要它"><span class="nav-number">3.</span> <span class="nav-text">controller的测试里不要出现$httpBackend，测service时才需要它</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#让module-inject引入我们mock过的provider-service"><span class="nav-number">4.</span> <span class="nav-text">让module/inject引入我们mock过的provider/service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其它小tip"><span class="nav-number">5.</span> <span class="nav-text">其它小tip</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#整合jquey插件的directive的测试流程"><span class="nav-number">5.1.</span> <span class="nav-text">整合jquey插件的directive的测试流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#将重复的测试代码重构成函数"><span class="nav-number">5.2.</span> <span class="nav-text">将重复的测试代码重构成函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试覆盖率"><span class="nav-number">5.3.</span> <span class="nav-text">测试覆盖率</span></a></li></ol></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </div>
      

    </div>
  </div>


    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp;  2010 - 
  2017
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">马斯特</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      $('.content img').each(function () {
        var $image = $(this);
        var $imageWrapLink = $image.parent('a');

        if ($imageWrapLink.size() < 1) {
          $imageWrapLink = $image.wrap('<a href="' + this.getAttribute('src') + '"></a>').parent('a');
        }
        $imageWrapLink.addClass('fancybox');
      });
    });
    $('.fancybox').fancybox({
      helpers: {
        overlay: {
          locked: false
        }
      }
    });
  </script>


  <script type="text/javascript">
  function hasMobileUA () {
    var nav = window.navigator;
    var ua = nav.userAgent;
    var pa = /iPad|iPhone|Android|Opera Mini|BlackBerry|webOS|UCWEB|Blazer|PSP|IEMobile|Symbian/g;

    return pa.test(ua);
  }

  function isDesktop () {
    return screen.width > 991 && !hasMobileUA();
  }

  function isTablet () {
    return screen.width < 992 && screen.width > 767 && hasMobileUA();
  }

  function isMobile () {
    return screen.width < 767 && hasMobileUA();
  }

  function escapeSelector (selector) {
    return selector.replace(/[!"$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, "\\$&")
  }
</script>

  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" id="motion.global">
  $(document).ready(function () {
    var body = $('body');
    var isSidebarVisible = false;
    var sidebarToggle = $('.sidebar-toggle');
    var sidebarToggleLine1st = $('.sidebar-toggle-line-first')
    var sidebarToggleLine2nd = $('.sidebar-toggle-line-middle');
    var sidebarToggleLine3rd = $('.sidebar-toggle-line-last');
    var sidebar = $('.sidebar');

    var SIDEBAR_WIDTH = '320px';
    var SIDEBAR_DISPLAY_DURATION = 300;

    var sidebarToogleLineStatusInit = {width: '100%', opacity: 1, left: 0, rotateZ: 0, top: 0};

    var sidebarToggleLine1stStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine1stStatusArrow = {width: '50%', rotateZ: '-45deg', top: '2px'};
    var sidebarToogleLine1stStatusClose = {width: '100%', rotateZ: '-45deg', top: '5px'};

    var sidebarToggleLine2ndStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine2ndStatusArrow = {width: '90%'};
    var sidebarToogleLine2ndStatusClose = {opacity: 0};

    var sidebarToggleLine3rdStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine3rdStatusArrow = {width: '50%', rotateZ: '45deg', top: '-2px'};
    var sidebarToogleLine3rdStatusClose = {width: '100%', rotateZ: '45deg', top: '-5px'};

    LogoAndMenuMotion();
    sidebatToggleMotion();
    postsListMotion();
    backToTopMotion();


    $(document)
      .on('sidebar.isShowing', function () {
        isDesktop() && body.velocity(
          {paddingRight: SIDEBAR_WIDTH},
          SIDEBAR_DISPLAY_DURATION
        );
        sidebarContentMotion();
      })
      .on('sidebar.isHiding', function () {});

    function LogoAndMenuMotion() {
      $.Velocity.RunSequence([
        { e: $('.brand'), p: { opacity: 1 }, o: { duration: 100 } },
        { e: $('.logo'), p: { opacity: 1, top: 0 }, o: { duration: 50} },
        
        { e: $('.site-title'), p: { opacity: 1, top: 0 }, o: { duration: 200 } }
      ]);
      $('.menu-item').velocity('transition.slideDownIn', {display: null});
    }


    function backToTopMotion () {
      var b2top = $('.back-to-top');
      b2top.on('click', function () {
        body.velocity('scroll');
      });
    }

    function sidebarShowMotion () {

      sidebarToggleLine1st.velocity(sidebarToogleLine1stStatusClose);
      sidebarToggleLine2nd.velocity(sidebarToogleLine2ndStatusClose);
      sidebarToggleLine3rd.velocity(sidebarToogleLine3rdStatusClose);

      sidebar.velocity({width: SIDEBAR_WIDTH}, {
        display: 'block',
        duration: SIDEBAR_DISPLAY_DURATION,
        complete: function () {
          sidebar.addClass('sidebar-active');
          sidebar.trigger('sidebar.didShow');
        }
      });
      sidebar.trigger('sidebar.isShowing');
    }

    function sidebarHideMotion () {
      isDesktop() && body.velocity({paddingRight: 0});
      sidebar.velocity('reverse');

      sidebarToggleLine1st.velocity(sidebarToggleLine1stStatusInit);
      sidebarToggleLine2nd.velocity(sidebarToggleLine2ndStatusInit);
      sidebarToggleLine3rd.velocity(sidebarToggleLine3rdStatusInit);

      sidebar.removeClass('sidebar-active');
      sidebar.trigger('sidebar.isHiding');
    };

    function sidebarContentMotion () {
      $('.sidebar .motion-element').velocity(
        'transition.slideRightIn',
        {stagger: 50, drag: true}
      );
    }

    function postsListMotion () {
      var postMotionOptions = window.postMotionOptions || {stagger: 300, drag: true};
      $('.post').velocity('transition.slideDownIn', postMotionOptions);
    }

    function sidebatToggleMotion () {
      sidebarToggle.on('click', function () {
        isSidebarVisible ? sidebarHideMotion() : sidebarShowMotion();
        isSidebarVisible = !isSidebarVisible;
      });

      sidebarToggle.hover(function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusArrow);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusArrow);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusArrow);
      }, function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusInit);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusInit);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusInit);
      });
    }
  });

</script>





  
  
<script type="text/javascript" id="bootstrap.scrollspy.custom">
  /* ========================================================================
  * Bootstrap: scrollspy.js v3.3.2
  * http://getbootstrap.com/javascript/#scrollspy
  * ========================================================================
  * Copyright 2011-2015 Twitter, Inc.
  * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
  * ======================================================================== */

  /**
   * Custom by iissnan
   *
   * - Add a `clear.bs.scrollspy` event.
   * - Esacpe targets selector.
   */


  +function ($) {
    'use strict';

    // SCROLLSPY CLASS DEFINITION
    // ==========================

    function ScrollSpy(element, options) {
      this.$body          = $(document.body)
      this.$scrollElement = $(element).is(document.body) ? $(window) : $(element)
      this.options        = $.extend({}, ScrollSpy.DEFAULTS, options)
      this.selector       = (this.options.target || '') + ' .nav li > a'
      this.offsets        = []
      this.targets        = []
      this.activeTarget   = null
      this.scrollHeight   = 0

      this.$scrollElement.on('scroll.bs.scrollspy', $.proxy(this.process, this))
      this.refresh()
      this.process()
    }

    ScrollSpy.VERSION  = '3.3.2'

    ScrollSpy.DEFAULTS = {
      offset: 10
    }

    ScrollSpy.prototype.getScrollHeight = function () {
      return this.$scrollElement[0].scrollHeight || Math.max(this.$body[0].scrollHeight, document.documentElement.scrollHeight)
    }

    ScrollSpy.prototype.refresh = function () {
      var that          = this
      var offsetMethod  = 'offset'
      var offsetBase    = 0

      this.offsets      = []
      this.targets      = []
      this.scrollHeight = this.getScrollHeight()

      if (!$.isWindow(this.$scrollElement[0])) {
        offsetMethod = 'position'
        offsetBase   = this.$scrollElement.scrollTop()
      }

      this.$body
        .find(this.selector)
        .map(function () {
          var $el   = $(this)
          var href  = $el.data('target') || $el.attr('href')
          var $href = /^#./.test(href) && $(escapeSelector(href)) // Need to escape selector.

          return ($href
            && $href.length
            && $href.is(':visible')
            && [[$href[offsetMethod]().top + offsetBase, href]]) || null
        })
        .sort(function (a, b) { return a[0] - b[0] })
        .each(function () {
          that.offsets.push(this[0])
          that.targets.push(this[1])
        })


    }

    ScrollSpy.prototype.process = function () {
      var scrollTop    = this.$scrollElement.scrollTop() + this.options.offset
      var scrollHeight = this.getScrollHeight()
      var maxScroll    = this.options.offset + scrollHeight - this.$scrollElement.height()
      var offsets      = this.offsets
      var targets      = this.targets
      var activeTarget = this.activeTarget
      var i

      if (this.scrollHeight != scrollHeight) {
        this.refresh()
      }

      if (scrollTop >= maxScroll) {
        return activeTarget != (i = targets[targets.length - 1]) && this.activate(i)
      }

      if (activeTarget && scrollTop < offsets[0]) {
        $(this.selector).trigger('clear.bs.scrollspy')  // Add a custom event.
        this.activeTarget = null
        return this.clear()
      }

      for (i = offsets.length; i--;) {
        activeTarget != targets[i]
          && scrollTop >= offsets[i]
          && (!offsets[i + 1] || scrollTop <= offsets[i + 1])
          && this.activate(targets[i])
      }
    }

    ScrollSpy.prototype.activate = function (target) {
      this.activeTarget = target

      this.clear()

      var selector = this.selector +
        '[data-target="' + target + '"],' +
        this.selector + '[href="' + target + '"]'

      var active = $(selector)
        .parents('li')
        .addClass('active')

      if (active.parent('.dropdown-menu').length) {
        active = active
          .closest('li.dropdown')
          .addClass('active')
      }

      active.trigger('activate.bs.scrollspy')
    }

    ScrollSpy.prototype.clear = function () {
      $(this.selector)
        .parentsUntil(this.options.target, '.active')
        .removeClass('active')
    }


    // SCROLLSPY PLUGIN DEFINITION
    // ===========================

    function Plugin(option) {
      return this.each(function () {
        var $this   = $(this)
        var data    = $this.data('bs.scrollspy')
        var options = typeof option == 'object' && option

        if (!data) $this.data('bs.scrollspy', (data = new ScrollSpy(this, options)))
        if (typeof option == 'string') data[option]()
      })
    }

    var old = $.fn.scrollspy

    $.fn.scrollspy             = Plugin
    $.fn.scrollspy.Constructor = ScrollSpy


    // SCROLLSPY NO CONFLICT
    // =====================

    $.fn.scrollspy.noConflict = function () {
      $.fn.scrollspy = old
      return this
    }


    // SCROLLSPY DATA-API
    // ==================

    $(window).on('load.bs.scrollspy.data-api', function () {
      $('[data-spy="scroll"]').each(function () {
        var $spy = $(this)
        Plugin.call($spy, $spy.data())
      })
    })

  }(jQuery);
</script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var $sidebarInner = $('.sidebar-inner');
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.didShow', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;
          var self = this;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      $(indicator).velocity('stop').velocity({
        opacity: action === 'show' ? 0.4 : 0
      }, { duration: 100 });
    }

  });
</script>


  <script type="text/javascript" id="sidebar.nav">
    $(document).ready(function () {
      var html = $('html');

      $('.sidebar-nav li').on('click', function () {
        var item = $(this);
        var activeTabClassName = 'sidebar-nav-active';
        var activePanelClassName = 'sidebar-panel-active';
        if (item.hasClass(activeTabClassName)) {
          return;
        }

        var currentTarget = $('.' + activePanelClassName);
        var target = $('.' + item.data('target'));

        currentTarget.velocity('transition.slideUpOut', 200, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', 200)
            .addClass(activePanelClassName);
        });

        item.siblings().removeClass(activeTabClassName);
        item.addClass(activeTabClassName);
      });

      $('.post-toc a').on('click', function (e) {
        e.preventDefault();
        var offset = $(escapeSelector(this.getAttribute('href'))).offset().top;
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        });
      });

      // Expand sidebar on post detail page by default, when post has a toc.
      var $tocContent = $('.post-toc-content');
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0 && isDesktop()) {
        setTimeout(function () {
          $('.sidebar-toggle').trigger('click');
        }, 800);
      }
    });
  </script>




  
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  
  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"pinkyjie-blog"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  


  
  <script type="text/javascript">
    (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
        function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='//www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
    ga('create','UA-45012422-1');ga('send','pageview');
  </script>

  
<div style="position:relative; bottom: 23px">
  <script src="http://s95.cnzz.com/stat.php?id=1253033676&web_id=1253033676&show=pic1" language="JavaScript">
  </script>
</div>


</body>
</html>
